<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" class="h-100" data-bs-theme="auto">
<head>
    <script src="/docs/5.3/assets/js/color-modes.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, 그리고 Bootstrap 기여자들">
    <meta name="generator" content="Hugo 0.122.0">
    <title>AI-Interview</title>

    <link rel="canonical" href="https://getbootstrap.kr/docs/5.3/examples/cover/">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 70vh;
            padding: 10px;
            margin-top: 30px;
        }

        .button-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .grid-item {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-danger {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        #videoElementUser {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #videoElementAI {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>

    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet">

    <script> // 면접 페이지에서 뒤로가기 못하게 막는 기능
        history.pushState(null, null, location.href);
        window.onpopstate = function (event) {
            history.go(1);
        };
    </script>
</head>
<body class="d-flex h-100 text-center text-bg-dark">

<div class="container-fluid d-flex w-100 h-100 p-3 mx-auto flex-column">
    <header class="mb-3">
        <div>
            <h3 class="float-md-center mb-0">AI-Interview</h3>
        </div>
    </header>

    <main class="px-3">
        <div class="mb-4">
            <h3 style="margin-top: 10px" id="questionElement">[[${session.questions.get(0)}]]</h3>
        </div>
        <div class="grid-container">
            <div class="grid-item">
                <video loop muted autoplay id="videoElementAI">
                    <source th:src="@{/media/InterviewAI.mp4}" type="video/mp4">
                </video>
            </div>
            <div class="grid-item">
                <video autoplay="true" id="videoElementUser">

                </video>
            </div>
        </div>
        <div class="mt-4 text-end">
            <div class="button-container">
                <button id="timerButton" class="btn btn-primary me-2">시간 타이머</button>
                <button id="nextButton" class="btn btn-success" onclick="showNextQuestion()">다음질문</button>
            </div>
        </div>
    </main>

    <footer class="mt-auto text-white-50">
        <p>© 2024 DevDays</p>
        <p>Video Source: https://www.youtube.com/watch?v=IFmto-5_oK8</p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    let timer = 90;
    let timerInterval;

    function startTimer() {
        timerInterval = setInterval(function() {
            timer--;
            updateTimerDisplay();

            if (timer <= 0) {
                clearInterval(timerInterval);
                setTimerButtonDanger();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timer / 60);
        const seconds = timer % 60;
        const timerElement = document.getElementById('timerButton');
        timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timer = 90;
        updateTimerDisplay();
        setTimerButtonPrimary();
    }

    function setTimerButtonDanger() {
        const timerElement = document.getElementById('timerButton');
        timerElement.classList.remove('btn-primary');
        timerElement.classList.add('btn-danger');
    }

    function setTimerButtonPrimary() {
        const timerElement = document.getElementById('timerButton');
        timerElement.classList.remove('btn-danger');
        timerElement.classList.add('btn-primary');
    }

    var video = document.querySelector("#videoElementUser");

    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                video.srcObject = stream;
            })
            .catch(function (error) {
                console.log("Something went wrong!");
            });
    }
</script>
<script th:inline="javascript">
    let currentQuestionIndex = -1;
    const questions = [[${session.questions}]];
    const nextButton = document.getElementById('nextButton');
    const coverLetterId = [[${session.coverLetterId}]];
    let isVoiceLoaded = false;

    function speakQuestion(text) {
        return new Promise((resolve) => {
            const utterance = new SpeechSynthesisUtterance(text);

            const voice = speechSynthesis.getVoices().find(voice => voice.name === 'Google 한국의');
            if (voice) {
                utterance.voice = voice;
            }

            utterance.rate = 0.9;
            utterance.pitch = 0.9;
            utterance.volume = 0.8;

            utterance.onend = () => {
                resolve();
            };

            window.speechSynthesis.speak(utterance);
        });
    }

    async function startInterview() {
        const introText = "안녕하세요, 면접 대상자님. 오늘 면접에 참여해 주셔서 감사합니다. 이제부터 면접을 시작하도록 하겠습니다. 편안한 마음으로 질문에 답변해 주시기 바랍니다.";
        document.getElementById('questionElement').textContent = introText;
        nextButton.disabled = true; // 버튼 비활성화
        await speakQuestion(introText);
        nextButton.disabled = false; // 버튼 활성화
        showNextQuestion();
    }

    async function showNextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
            const questionText = questions[currentQuestionIndex];
            document.getElementById('questionElement').textContent = questionText;
            resetTimer();
            nextButton.disabled = true;
            await speakQuestion(questionText);
            nextButton.disabled = false;
            startTimer();
            if (currentQuestionIndex === questions.length - 1) {
                nextButton.textContent = '면접 끝내기';
                nextButton.onclick = function() {
                    finishInterview();
                };
            }
        }
    }

    function finishInterview() {
        window.location.href = '/list/' + coverLetterId + '/interview/finish';
    }

    function onVoicesLoaded() {
        isVoiceLoaded = true;
        startInterview();
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = onVoicesLoaded;
    }

    if (isVoiceLoaded) {
        startInterview();
    }
</script>
</body>
</html>